name: Libft Project CI

on:
  push:
    branches: [ main, master, 'feat/**' ]
  pull_request:
    branches: [ main, master ]

env:
  PROJECT_NAME: "libft"
  LIB_NAME: "libft.a"

jobs:
  check-quality:
    name: Norminette & Compilation
    runs-on: ubuntu-latest

    steps:
      # 1. R√©cup√©ration du code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Setup Python (Action officielle plus rapide que apt-get)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. Installation Norminette
      - name: Install Norminette 42
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install norminette

      # 4. V√©rification de la norme
      - name: Run Norminette
        id: norm-step
        run: |
          echo "üîç V√©rification de la norme..."
          FILES=$(find . -name "*.c" -o -name "*.h" | grep -v "./.git")
          if [ -z "$FILES" ]; then
            echo "‚ùå Aucun fichier source trouv√© !"
            exit 1
          fi
          norminette $FILES
          echo "‚úÖ Norme respect√©e."

      # 5. Tests du Makefile (Le c≈ìur de l'automatisation)
      - name: Test Makefile Compilation
        id: make-step
        run: |
          echo "üõ†Ô∏è D√©but des tests de compilation..."
          
          # V√©rification de l'existence
          if [ ! -f "Makefile" ]; then echo "‚ùå Makefile manquant !"; exit 1; fi

          # Test All
          echo "Test: make all..."
          make all
          if [ ! -f "$LIB_NAME" ]; then echo "‚ùå $LIB_NAME non g√©n√©r√© !"; exit 1; fi

          # Test Bonus
          echo "Test: make bonus..."
          make bonus || echo "‚ÑπÔ∏è Pas de r√®gle bonus ou √©chec (optionnel)"

          # Test Clean
          echo "Test: make clean..."
          make clean
          
          # Test Fclean
          echo "Test: make fclean..."
          make fclean
          if [ -f "$LIB_NAME" ]; then echo "‚ùå $LIB_NAME toujours pr√©sent apr√®s fclean !"; exit 1; fi

          # Test Re (Critique pour 42)
          echo "Test: make re..."
          make re
          if [ ! -f "$LIB_NAME" ]; then echo "‚ùå make re n'a pas recr√©√© la biblioth√®que !"; exit 1; fi
          
          echo "‚úÖ Tests de compilation r√©ussis."

      # 6. Rapport Final
      - name: DevOps Final Report
        if: always()
        run: |
          echo "=========================================="
          echo "üöÄ RAPPORT FINAL POUR ${{ env.PROJECT_NAME }}"
          echo "Norminette  : ${{ steps.norm-step.outcome }}"
          echo "Compilation : ${{ steps.make-step.outcome }}"
          echo "=========================================="